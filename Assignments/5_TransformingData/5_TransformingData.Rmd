# Transforming data

Sometimes long data needs to be wide, and sometimes wide data needs to be long. I'll explain.

You are soon going to discover that long before you can visualize data, you need to have it in a form that the visualization library can deal with. We started that with dates. One of the ways that isn't immediately obvious is how your data is cast. Most of the data you will encounter will be wide -- each row will represent a single entity with multiple measures for that entity. So think of states. Your dataset could have population, average life expectancy and other demographic data. 

But what if your visualization library needs one row for each measure? That's where recasting your data comes in. We can use a library called `tidyr` to `gather` or `spread` the data, depending on what we need.

We'll use an example of graduation rate data from the NCAA. First we need some libraries. 

```{r}
library(dplyr)
library(tidyr)
library(readr)
```

Now we'll grab the data. 

```{r}
graduation <- read_csv('../../Data/gradrates.csv')
```

```{r}
head(graduation)
```

So what you see here is what is known as long data -- each row is a school, a gender and a year combination. So 1998 men for a school, 1999 women for a school, so on and so forth. This is not what you're used to if you're accustomed to spreadsheets for analysis. And, if you want to calculate the percent change in graduation rates between two years, you can't do it with this. You need all years on one line, with the year as a colunn instead of a value of data. 

Let's start by simplifying our data some. 

```{r}
spreaddata <- graduation %>% select(`Institution name`, `Cohort year`, Gender, `Graduation rate (%)`)

head(spreaddata)
```

To take long data and make it wide, we need to `spread` the data. That's the new verb. To spread the data, we tell spread what the new columns will be and what the data values that will go with them. Spread does the rest. 

```{r}
spreaddata %>% spread(`Cohort year`, `Graduation rate (%)`)
```
So now, if we wanted to calculate some percent changes, we could. We have the data where it needs to be.

We can reverse this process as well. If we get data that's wide and we want to make it long, we use `gather`. So first, since my data is already long, let me fake a wide dataset using what I just did. 

```{r}
gatherdata <- spreaddata %>% spread(`Cohort year`, `Graduation rate (%)`)
```

```{r}
head(gatherdata)
```

Oh drat, the NCAA has given me wide data and for a visualization project, I need long data. Whatever will I do? 

Gather, unfortunately, isn't as easy as spread. It can take some fiddling to get right. There's a ton of examples online if you Google for them, but here's what you do: You tell `gather` what the new column of data you are creating out of the field names first, you then tell it what the value field is going to be called. In our case, since we had two other fields, we need to tell `gather` to enumerate data by these things to, and we do it with the negative sign, and then we tell `gather` which fields are getting made into long values. In this case, I used the numbers of the fields -- field 3 to field 14 -- instead of naming them.

```{r}
gatherdata %>% gather(`Cohort Year`, `Graduation rate (%)`, -`Institution name`, -Gender,  3:14)
```

And just like that, we're back where we started. 

### Why this matters

This matters because certain visualization types need wide or long data. A significant hurdle you will face for the rest of the semester is getting the data in the right format for what you want to do. 

So let me walk you through an example using this data. I want to put every school's graduation rates on a line and then show you were Nebraska ranks. Do men or women graduate at higher rates? And how does UNL compare to other schools? 

First we import our charting library. 

```{r}
library(ggplot2)
```

The first thing I have to do is make a date out of a year -- ggplot2 doesn't see 1998 as a date, so I'm going to mutate a field into a date by adding a fake day and month. 

This uses mutate and date formatting, which we've talked about.

```{r}
gradplotdata <- graduation %>% mutate(CohortDate=as.Date(paste(`Cohort year`, "-01-01", sep="")))

head(gradplotdata)
```
Now I'm going to create a subset of the data for just UNL. 

```{r}
nu <- gradplotdata %>% filter(`Institution name` == "University of Nebraska, Lincoln")
```

Now I'm ready to plot things. You'll read about this for next class, but ggplot2 implements something called the Grammar of Graphics. It uses Aesthetics to describe the data involved -- the x and y axis among others. And it uses Geometries to give the data shape. 

We're going to do something a little more complicated here than we will for a few weeks but it's not hard to follow along. First, we start an empty plot. Then our first geometry -- `geom_line` -- gets a data element, the aesthetics (aes) which says the x is the CohortDate and y is the Graduation Rate (%) and we're going to show lines for each Institution and Gender. Also, color it light grey. Then we're going to add another geom_line, this one for UNL. The only difference here is we add the color to the AES, so each variable gets a color instead of everything getting the same color. Here's what it looks like: 

```{r}
ggplot() + geom_line(data = gradplotdata, aes(x=CohortDate, y=`Graduation rate (%)`, group=interaction(`Institution name`, Gender)), color="light grey") + geom_line(data = nu, aes(x=CohortDate, y=`Graduation rate (%)`, color=Gender))
```
What does this chart tell you?

### Assignment

* Read [A Layered Grammar of Graphics](https://byrneslab.net/classes/biol607/readings/wickham_layered-grammar.pdf) by Hadley Wickham. 
* Watch Wickham, who created the libraries we are using, [work through a data project](https://www.youtube.com/watch?v=go5Au01Jrvs). 

